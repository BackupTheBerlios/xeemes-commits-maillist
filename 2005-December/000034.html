<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Xeemes-commits] r36 - in trunk: . src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/xeemes-commits/2005-December/index.html" >
   <LINK REL="made" HREF="mailto:xeemes-commits%40lists.berlios.de?Subject=Re%3A%20%5BXeemes-commits%5D%20r36%20-%20in%20trunk%3A%20.%20src&In-Reply-To=%3C200512011853.jB1IrvoH018606%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Xeemes-commits] r36 - in trunk: . src</H1>
    <B>dfrese at BerliOS</B> 
    <A HREF="mailto:xeemes-commits%40lists.berlios.de?Subject=Re%3A%20%5BXeemes-commits%5D%20r36%20-%20in%20trunk%3A%20.%20src&In-Reply-To=%3C200512011853.jB1IrvoH018606%40sheep.berlios.de%3E"
       TITLE="[Xeemes-commits] r36 - in trunk: . src">dfrese at berlios.de
       </A><BR>
    <I>Thu Dec  1 19:53:57 CET 2005</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34">[ date ]</a>
              <a href="thread.html#34">[ thread ]</a>
              <a href="subject.html#34">[ subject ]</a>
              <a href="author.html#34">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dfrese
Date: 2005-12-01 19:53:54 +0100 (Thu, 01 Dec 2005)
New Revision: 36

Added:
   trunk/src/mime-types.inc
   trunk/src/mime.types
Modified:
   trunk/src/authenticate.inc
   trunk/src/resources.inc
   trunk/src/tags.inc
   trunk/src/transformation.inc
   trunk/src/wikipedia.inc
   trunk/view.php
Log:
Subject: Added caching and other major updates



Modified: trunk/src/authenticate.inc
===================================================================
--- trunk/src/authenticate.inc	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/src/authenticate.inc	2005-12-01 18:53:54 UTC (rev 36)
@@ -24,44 +24,134 @@
  */
 
 function verify_view_authorization($resource) {
-  $edir = dirname($resource-&gt;getLocation());
+  // test weather php runs as a module
+  /*  if (function_exists('apache_request_headers'))
+    return verify_view_authorization_via_http($resource);
+  else*/
+    return verify_view_authorization_via_cookie($resource);
+}
+
+function verify_view_authorization_get_htaccess($resource) {
+  $loc = $resource-&gt;getLocation();
+  if ($loc[strlen($loc)-1] == '/')
+    $edir = $loc;
+  else
+    $edir = dirname($loc);
   while (!file_exists(XEEMES_BASE_DIR.'/data'.$edir.'/.htaccess')) {
     if ($edir == '/') $edir = '';
     if ($edir == '')
-      return; // no htaccess file found
+      return false; // no htaccess file found
     else
       $edir = dirname($edir);
   }
   $htaccess = new htaccess(XEEMES_BASE_DIR.'/data'.$edir.'/.htaccess');
   $htaccess-&gt;load();
 
+  return $htaccess;
+}
+
+function verify_view_authorization_check($htaccess, $user, $pw) {
+  $htpasswd = $htaccess-&gt;getAuthUserFile();
+  $htpasswd-&gt;load();
+  $htgroups = $htaccess-&gt;getAuthGroupFile();
+
+  return (($htpasswd-&gt;validUser($user, $pw)) &amp;&amp;
+	  ( ($require[0] == HTACCESS_REQUIRE_VALID_USER) ||
+	    (($require[0] == HTACCESS_REQUIRE_USER) &amp;&amp;
+	     in_array($user, $require[1])) ||
+	    (($require[0] == HTACCESS_REQUIRE_GROUP) &amp;&amp;
+	     ($htgroups-&gt;load() || true) &amp;&amp;
+	     in_array($user, $htgroups-&gt;getGroup($require[1]))) ));
+}
+
+function get_and_save_random_password() {
+  $filename = XEEMES_BASE_DIR.'/src/.password';
+  // TODO: not concurrency-safe
+  $ex = file_exists($filename);
+  $fh = fopen($filename, &quot;w+&quot;);
+  if ($ex)
+    $res = fgets($fh);
+  else {
+    $res = '';
+    for ($i = 0; $i &lt; 8; $i++)
+      $res .= chr(rand(48, 122));
+    fputs($fh, $res);
+  }
+  fclose($fh);
+  return $res;
+}
+
+function verify_view_authorization_via_cookie($resource) {
+  $htaccess = verify_view_authorization_get_htaccess($resource);
+  if (!$htaccess) return false;
+
   // see if authorization is required
   $require = $htaccess-&gt;getRequire();
   if ($require == null)
-    return;
+    return false;
 
-  // check passed headers
-  if (isset($_SERVER['PHP_AUTH_USER'])) {
+  $realm = $htaccess-&gt;getAuthName();
+
+  // check cookie, or posted credentials
+  if (isset($_COOKIE['xeemes-auth-'.$realm])) {
     $htpasswd = $htaccess-&gt;getAuthUserFile();
     $htpasswd-&gt;load();
     $htgroups = $htaccess-&gt;getAuthGroupFile();
 
+    $crypt_pw = get_and_save_random_password();
+    $auth_info = unserialize(crypt($_COOKIE['xeemes-auth'], $crypt_pw));
+    $user = $auth_info[0];
+    $pw = $auth_info[1];
+    
+    if (verify_view_authorization_check($htaccess, $user, $pw))
+      return true;
+  }
+  if (isset($_POST['xeemes-user'])) {
+    $user = $_POST['xeemes-user'];
+    $pw = $_POST['xeemes-pw'];
+
+    if (verify_view_authorization_check($htaccess, $user, $pw)) {
+      // save in a cookie
+      $crypt_pw = get_and_save_random_password();
+      $auth_info = array($user, $pw);
+      setcookie('xeemes-auth-'.$realm,
+		crypt(serialize($auth_info), $crypt_pw),
+		time()+3600, $resource-&gt;getLocation());
+      return true;
+    }
+  }
+
+  // send page with login form
+  header('Content-type: text/html');
+  // TODO: put through layout of default or this/parent resource
+  print('&lt;html&gt;&lt;body&gt;&lt;form method=&quot;POST&quot;&gt;&lt;table&gt;'.
+	'&lt;tr&gt;&lt;td&gt;Username:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; size=&quot;30&quot; name=&quot;xeemes-user&quot;/&gt;&lt;/td&gt;&lt;/tr&gt;'.
+	'&lt;tr&gt;&lt;td&gt;Password:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;password&quot; size=&quot;30&quot; name=&quot;xeemes-pw&quot;/&gt;&lt;/td&gt;&lt;/tr&gt;'.
+	'&lt;/table&gt;&lt;input type=&quot;submit&quot;/&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;');
+  exit();
+}
+
+function verify_view_authorization_via_http($resource) {
+  $htaccess = verify_view_authorization_get_htaccess($resource);
+  if (!$htaccess) return false;
+
+  // see if authorization is required
+  $require = $htaccess-&gt;getRequire();
+  if ($require == null)
+    return false;
+
+  // check passed headers
+  if (isset($_SERVER['PHP_AUTH_USER'])) {
     /*$str = base64_decode($_SERVER['HTTP_AUTHORIZATION']);
     $pos = strpos($str, ':');
     $user = substr($str, 0, $pos);
     $pw = substr($str, $pos+1);*/
+
     $user = $_SERVER['PHP_AUTH_USER'];
     $pw = $_SERVER['PHP_AUTH_PW'];
 
-    if (($htpasswd-&gt;validUser($user, $pw)) &amp;&amp;
-	( ($require[0] == HTACCESS_REQUIRE_VALID_USER) ||
-	  (($require[0] == HTACCESS_REQUIRE_USER) &amp;&amp;
-	   in_array($user, $require[1])) ||
-	  ((($htgroups-&gt;load() || true) &amp;&amp;
-	    ($require[0] == HTACCESS_REQUIRE_GROUP) &amp;&amp;
-	    in_array($user, $htgroups-&gt;getGroup($require[1]))) )))
-      // OK
-      return;
+    if (verify_view_authorization_check($htaccess, $user, $pw))
+      return true;
   }
   
   // send need for authorization requirement
@@ -72,7 +162,7 @@
     exit();
   } else {
     // TODO: internal error: type not supported
-    return;
+    return false;
   }
 }
 
@@ -248,8 +338,9 @@
 
   function validUser($user, $password) {
     foreach ($this-&gt;lines as $line) {
-      if (preg_match('/^'.preg_quote($user).':(.*)/', $line, $matches))
+      if (preg_match('/^'.preg_quote($user).':(.*)/', $line, $matches)) {
 	return (crypt($password, substr($matches[1], 0, 2)) == $matches[1]);
+      }
     }
     return false;
   }

Added: trunk/src/mime-types.inc
===================================================================
--- trunk/src/mime-types.inc	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/src/mime-types.inc	2005-12-01 18:53:54 UTC (rev 36)
@@ -0,0 +1,40 @@
+&lt;?php
+
+function mime_content_type_ex($filename) {
+  $handle = @fopen(XEEMES_BASE_DIR.&quot;/src/mime.types&quot;, &quot;r&quot;);
+  //$filehandle = @fopen($filename, &quot;r&quot;);
+  $result = false;
+  if ($handle) {
+    while (!feof($handle)) {
+      $buffer = trim(fgets($handle));
+      /* a line is blank, a comment, or a rule line */
+      if (($buffer != '') &amp;&amp; ($buffer[0] != '#')) {
+	if (preg_match('/([\S]+)\s+(.*)/', $buffer, $matches)) {
+	  $type = $matches[1];
+	  $rules = $matches[2];
+	  if (mime_test_rules($filename, $filehandle, $rules)) {
+	    $result = $type;
+	    break;
+	  }
+	} // else syntax error
+      }
+    }
+    fclose($handle);
+  }
+  //if ($filehandle) fclose($filehandle);
+  return $result;
+}
+
+function mime_test_rules($filename, $fh, $rules_spec) {
+  if (strpos($rules_spec, '(') !== false)
+    die('Functions and grouping in mime-types not implemented');
+  $rules = preg_split('/[\s,]+/', $rules_spec);
+  $info = pathinfo($filename);
+  foreach ($rules as $rule) {
+    if (strcasecmp($rule, $info['extension']) == 0)
+      return true;
+  }
+  return false;
+}
+
+?&gt;

Added: trunk/src/mime.types
===================================================================
--- trunk/src/mime.types	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/src/mime.types	2005-12-01 18:53:54 UTC (rev 36)
@@ -0,0 +1,648 @@
+###############################################################################
+#
+#  MIME-TYPES and the extensions that represent them
+#
+#  This file is part of the app-misc/mime-types package, which is based on 
+#  debian's &quot;mime-support&quot;.  Please file a bug if you would like new types
+#  and/or extensions to be added on <A HREF="http://bugs.gentoo.org">http://bugs.gentoo.org</A>
+#
+#  Users can add their own types if they wish by creating a &quot;.mime.types&quot;
+#  file in their home directory.  Definitions included there will take
+#  precedence over those listed here.
+#
+#  Note: Compression schemes like &quot;gzip&quot;, &quot;bzip&quot;, and &quot;compress&quot; are not
+#  actually &quot;mime-types&quot;.  They are &quot;encodings&quot; and hence must _not_ have
+#  entries in this file to map their extensions.  The &quot;mime-type&quot; of an
+#  encoded file refers to the type of data that has been encoded, not the
+#  type of the encoding.
+#
+###############################################################################
+
+
+application/activemessage
+application/andrew-inset			ez
+application/applefile
+application/atomicmail
+application/batch-SMTP
+application/beep+xml
+application/cals-1840
+application/commonground
+application/cu-seeme				csm cu
+application/cybercash
+application/dca-rft
+application/dec-dx
+application/dsptype				tsp
+application/dvcs
+application/edi-consent
+application/edifact
+application/edi-x12
+application/eshop
+application/font-tdpfr
+application/futuresplash			spl
+application/ghostview
+application/hta					hta
+application/http
+application/hyperstudio
+application/iges
+application/index
+application/index.cmd
+application/index.obj
+application/index.response
+application/index.vnd
+application/iotp
+application/ipp
+application/isup
+application/mac-compactpro			cpt
+application/marc
+application/mac-binhex40			hqx
+application/macwriteii
+application/mathematica				nb
+application/mathematica-old
+application/msaccess				mdb
+application/msword				doc dot
+application/news-message-id
+application/news-transmission
+application/octet-stream			bin
+application/ocsp-request
+application/ocsp-response
+application/oda					oda
+application/parityfec
+application/pics-rules				prf
+application/pgp-encrypted
+application/pgp-keys				key
+application/pdf					pdf
+application/pgp-signature			pgp
+application/pkcs10
+application/pkcs7-mime
+application/pkcs7-signature
+application/pkix-cert
+application/pkixcmp
+application/pkix-crl
+application/postscript				ps ai eps
+application/prs.alvestrand.titrax-sheet
+application/prs.cww
+application/prs.nprend
+application/qsig
+application/rar					rar
+application/riscos
+application/remote-printing
+application/rss+xml				rss
+application/rtf					rtf
+application/sdp
+application/set-payment
+application/set-payment-initiation
+application/set-registration
+application/set-registration-initiation
+application/sgml
+application/sgml-open-catalog
+application/sieve
+application/slate
+application/smil				smi smil
+application/timestamp-query
+application/timestamp-reply
+application/vemmi
+application/whoispp-query
+application/whoispp-response
+application/wita
+application/wordperfect5.1			wp5
+application/zip					zip
+application/x400-bp
+application/xml
+application/xml-dtd
+application/xml-external-parsed-entity
+application/vnd.3M.Post-it-Notes
+application/vnd.accpac.simply.aso
+application/vnd.accpac.simply.imp
+application/vnd.acucobol
+application/vnd.aether.imp
+application/vnd.anser-web-certificate-issue-initiation
+application/vnd.anser-web-funds-transfer-initiation
+application/vnd.audiograph
+application/vnd.bmi
+application/vnd.businessobjects
+application/vnd.canon-cpdl
+application/vnd.canon-lips
+application/vnd.cinderella			cdy
+application/vnd.claymore
+application/vnd.commerce-battelle
+application/vnd.commonspace
+application/vnd.comsocaller
+application/vnd.contact.cmsg
+application/vnd.cosmocaller
+application/vnd.ctc-posml
+application/vnd.cups-postscript
+application/vnd.cups-raster
+application/vnd.cups-raw
+application/vnd.cybank
+application/vnd.dna
+application/vnd.dpgraph
+application/vnd.dxr
+application/vnd.ecdis-update
+application/vnd.ecowin.chart
+application/vnd.ecowin.filerequest
+application/vnd.ecowin.fileupdate
+application/vnd.ecowin.series
+application/vnd.ecowin.seriesrequest
+application/vnd.ecowin.seriesupdate
+application/vnd.enliven
+application/vnd.epson.esf
+application/vnd.epson.msf
+application/vnd.epson.quickanime
+application/vnd.epson.salt
+application/vnd.epson.ssf
+application/vnd.ericsson.quickcall
+application/vnd.eudora.data
+application/vnd.fdf
+application/vnd.ffsns
+application/vnd.flographit
+application/vnd.framemaker
+application/vnd.fsc.weblaunch
+application/vnd.fujitsu.oasys
+application/vnd.fujitsu.oasys2
+application/vnd.fujitsu.oasys3
+application/vnd.fujitsu.oasysgp
+application/vnd.fujitsu.oasysprs
+application/vnd.fujixerox.ddd
+application/vnd.fujixerox.docuworks
+application/vnd.fujixerox.docuworks.binder
+application/vnd.fut-misnet
+application/vnd.grafeq
+application/vnd.groove-account
+application/vnd.groove-identity-message
+application/vnd.groove-injector
+application/vnd.groove-tool-message
+application/vnd.groove-tool-template
+application/vnd.groove-vcard
+application/vnd.hhe.lesson-player
+application/vnd.hp-HPGL
+application/vnd.hp-hpid
+application/vnd.hp-hps
+application/vnd.hp-PCL
+application/vnd.hp-PCLXL
+application/vnd.httphone
+application/vnd.hzn-3d-crossword
+application/vnd.ibm.afplinedata
+application/vnd.ibm.MiniPay
+application/vnd.ibm.modcap
+application/vnd.informix-visionary
+application/vnd.intercon.formnet
+application/vnd.intertrust.digibox
+application/vnd.intertrust.nncp
+application/vnd.intu.qbo
+application/vnd.intu.qfx
+application/vnd.irepository.package+xml
+application/vnd.is-xpr
+application/vnd.japannet-directory-service
+application/vnd.japannet-jpnstore-wakeup
+application/vnd.japannet-payment-wakeup
+application/vnd.japannet-registration
+application/vnd.japannet-registration-wakeup
+application/vnd.japannet-setstore-wakeup
+application/vnd.japannet-verification
+application/vnd.japannet-verification-wakeup
+application/vnd.koan
+application/vnd.lotus-1-2-3
+application/vnd.lotus-approach
+application/vnd.lotus-freelance
+application/vnd.lotus-notes
+application/vnd.lotus-organizer
+application/vnd.lotus-screencam
+application/vnd.lotus-wordpro
+application/vnd.mcd
+application/vnd.mediastation.cdkey
+application/vnd.meridian-slingshot
+application/vnd.mif	      mif
+application/vnd.minisoft-hp3000-save
+application/vnd.mitsubishi.misty-guard.trustweb
+application/vnd.mobius.daf
+application/vnd.mobius.dis
+application/vnd.mobius.msl
+application/vnd.mobius.plc
+application/vnd.mobius.txf
+application/vnd.motorola.flexsuite
+application/vnd.motorola.flexsuite.adsi
+application/vnd.motorola.flexsuite.fis
+application/vnd.motorola.flexsuite.gotap
+application/vnd.motorola.flexsuite.kmr
+application/vnd.motorola.flexsuite.ttc
+application/vnd.motorola.flexsuite.wem
+application/vnd.mozilla.xul+xml			xul
+application/vnd.ms-artgalry
+application/vnd.ms-asf
+application/vnd.mseq
+application/vnd.ms-excel			xls xlb xlt
+application/vnd.msign
+application/vnd.ms-lrm
+application/vnd.ms-pki.seccat			cat
+application/vnd.ms-pki.stl			stl
+application/vnd.ms-powerpoint			ppt pps
+application/vnd.ms-project
+application/vnd.ms-tnef
+application/vnd.ms-works
+application/vnd.musician
+application/vnd.music-niff
+application/vnd.netfpx
+application/vnd.noblenet-directory
+application/vnd.noblenet-sealer
+application/vnd.noblenet-web
+application/vnd.novadigm.EDM
+application/vnd.novadigm.EDX
+application/vnd.novadigm.EXT
+application/vnd.osa.netdeploy
+application/vnd.palm
+application/vnd.pg.format
+application/vnd.pg.osasli
+application/vnd.powerbuilder6
+application/vnd.powerbuilder6-s
+application/vnd.powerbuilder7
+application/vnd.powerbuilder75
+application/vnd.powerbuilder75-s
+application/vnd.powerbuilder7-s
+application/vnd.previewsystems.box
+application/vnd.publishare-delta-tree
+application/vnd.pvi.ptid1
+application/vnd.pwg-xhtml-print+xml
+application/vnd.rapid
+application/vnd.s3sms
+application/vnd.seemail
+application/vnd.shana.informed.formdata
+application/vnd.shana.informed.formtemplate
+application/vnd.shana.informed.interchange
+application/vnd.shana.informed.package
+application/vnd.smaf				mmf
+application/vnd.sss-cod
+application/vnd.sss-dtf
+application/vnd.sss-ntf
+application/vnd.stardivision.writer		sdw vor
+application/vnd.stardivision.writer-global	sgl
+application/vnd.stardivision.writer		vor
+application/vnd.stardivision.calc		sdc
+application/vnd.stardivision.draw		sda
+application/vnd.stardivision.impress		sdd
+application/vnd.stardivision.impress-packed	sdp
+application/vnd.stardivision.math		smf
+application/vnd.stardivision.chart		sds
+application/vnd.stardivision.mail		smd
+application/vnd.street-stream
+application/vnd.sun.xml.calc			sxc
+application/vnd.sun.xml.calc.template		stc
+application/vnd.sun.xml.draw			sxd
+application/vnd.sun.xml.draw.template		std
+application/vnd.sun.xml.impress			sxi
+application/vnd.sun.xml.impress.template	sti
+application/vnd.sun.xml.math			sxm
+application/vnd.sun.xml.writer			sxw
+application/vnd.sun.xml.writer.global		sxg
+application/vnd.sun.xml.writer.template		stw
+application/vnd.svd
+application/vnd.swiftview-ics
+application/vnd.symbian.install			sis
+application/vnd.triscape.mxs
+application/vnd.trueapp
+application/vnd.truedoc
+application/vnd.tve-trigger
+application/vnd.ufdl
+application/vnd.uplanet.alert
+application/vnd.uplanet.alert-wbxml
+application/vnd.uplanet.bearer-choice
+application/vnd.uplanet.bearer-choice-wbxml
+application/vnd.uplanet.cacheop
+application/vnd.uplanet.cacheop-wbxml
+application/vnd.uplanet.channel
+application/vnd.uplanet.channel-wbxml
+application/vnd.uplanet.list
+application/vnd.uplanet.listcmd
+application/vnd.uplanet.listcmd-wbxml
+application/vnd.uplanet.list-wbxml
+application/vnd.uplanet.signal
+application/vnd.vcx
+application/vnd.vectorworks
+application/vnd.vidsoft.vidconference
+application/vnd.visio				vsd
+application/vnd.vividence.scriptfile
+application/vnd.wap.sic
+application/vnd.wap.slc
+application/vnd.wap.wbxml			wbxml
+application/vnd.wap.wmlc			wmlc
+application/vnd.wap.wmlscriptc			wmlsc
+application/vnd.webturbo
+application/vnd.wrq-hp3000-labelled
+application/vnd.wt.stf
+application/vnd.xara
+application/vnd.xfdl
+application/vnd.yellowriver-custom-menu
+application/x-123				wk
+application/x-apple-diskimage			dmg
+application/x-bcpio				bcpio
+application/x-bittorrent			torrent
+application/x-cdf				cdf
+application/x-cdlink				vcd
+application/x-chess-pgn				pgn
+application/x-core
+application/x-cpio				cpio
+application/x-csh				csh
+application/x-debian-package			deb
+application/x-director				dcr dir dxr
+application/x-doom				wad
+application/x-dms				dms
+application/x-dvi				dvi
+application/x-executable
+application/x-font				pfa pfb gsf pcf pcf.Z
+application/x-futuresplash			spl
+application/x-gnumeric				gnumeric
+application/x-go-sgf				sgf
+application/x-graphing-calculator		gcf
+application/x-gtar				gtar tgz taz
+application/x-hdf				hdf
+application/x-httpd-php				phtml pht php
+application/x-httpd-php-source			phps
+application/x-httpd-php3			php3
+application/x-httpd-php3-source			phps
+application/x-httpd-php3-preprocessed		php3p
+application/x-httpd-php4			php4
+application/x-ica				ica
+application/x-internet-signup			ins isp
+application/x-iphone				iii
+application/x-java-applet
+application/x-java-archive			jar
+application/x-java-bean
+application/x-java-jnlp-file			jnlp
+application/x-java-serialized-object		ser
+application/x-java-vm				class
+application/x-javascript			js
+application/x-kdelnk
+application/x-kchart				chrt
+application/x-killustrator			kil
+application/x-kpresenter			kpr kpt
+application/x-koan				skp skd skt skm
+application/x-kspread				ksp
+application/x-kword				kwd kwt
+application/x-latex				latex
+application/x-lha				lha
+application/x-lzh				lzh
+application/x-lzx				lzx
+application/x-maker				frm maker frame fm fb book fbdoc
+application/x-mif				mif
+application/x-ms-wmz				wmz
+application/x-ms-wmd				wmd
+application/x-msdos-program			com exe bat dll
+application/x-msi				msi
+application/x-netcdf				nc
+application/x-ns-proxy-autoconfig		pac
+application/x-nwc				nwc
+application/x-object				o
+application/x-ogg				ogg
+application/x-oz-application			oza
+application/x-perl				pl pm
+application/x-pkcs7-certreqresp			p7r
+application/x-pkcs7-crl				crl
+application/x-python-code			pyc pyo
+application/x-quicktimeplayer			qtl
+application/x-redhat-package-manager		rpm
+application/x-rx
+application/x-sh
+application/x-shar				shar
+application/x-shellscript
+application/x-shockwave-flash			swf swfl
+application/x-sh				sh
+application/x-stuffit				sit
+application/x-sv4cpio				sv4cpio
+application/x-sv4crc				sv4crc
+application/x-tar				tar
+application/x-tcl				tcl
+application/x-tex				tex
+application/x-tex-gf				gf
+application/x-tex-pk				pk
+application/x-texinfo				texinfo texi
+application/x-trash				~ % bak old sik
+application/x-troff				t tr roff
+application/x-troff-man				man
+application/x-troff-me				me
+application/x-troff-ms				ms
+application/x-ustar				ustar
+application/x-wais-source			src
+application/x-wingz				wz
+application/x-x509-ca-cert			crt
+application/x-xfig				fig
+
+audio/32kadpcm
+#audio/aiff					aif aifc aiff
+audio/basic					au snd
+audio/g.722.1
+audio/l16
+audio/midi					mid midi kar
+audio/mp4a-latm
+audio/mpa-robust
+audio/mpeg					mpga mpega mp2 mp3 m4a
+audio/mpegurl					m3u
+audio/parityfec
+audio/prs.sid					sid
+audio/telephone-event
+audio/tone
+#audio/x-wav					wav
+audio/vnd.cisco.nse
+audio/vnd.cns.anp1
+audio/vnd.cns.inf1
+audio/vnd.digital-winds
+audio/vnd.everad.plj
+audio/vnd.lucent.voice
+audio/vnd.nortel.vbk
+audio/vnd.nuera.ecelp4800
+audio/vnd.nuera.ecelp7470
+audio/vnd.nuera.ecelp9600
+audio/vnd.octel.sbc
+audio/vnd.qcelp
+audio/vnd.rhetorex.32kadpcm
+audio/vnd.vmx.cvsd
+audio/x-aiff					aif aiff aifc
+audio/x-gsm					gsm
+audio/x-mpegurl					m3u
+audio/x-ms-wma					wma
+audio/x-ms-wax					wax
+audio/x-pn-realaudio-plugin			rpm
+audio/x-pn-realaudio				ra rm ram
+audio/x-realaudio				ra
+audio/x-scpls					pls
+audio/x-sd2					sd2
+audio/x-wav					wav
+
+chemical/x-pdb					pdb
+chemical/x-xyz					xyz
+image/bmp					bmp
+image/cgm
+image/g3fax
+image/gif					gif
+image/ief					ief
+image/jpeg					jpeg jpg jpe
+image/naplps
+image/pcx					pcx
+image/png					png
+image/prs.btif
+image/prs.pti
+image/svg+xml					svg svgz
+image/tiff					tiff tif
+image/vnd.cns.inf2
+image/vnd.dwg
+image/vnd.dxf
+image/vnd.fastbidsheet
+image/vnd.fpx
+image/vnd.fst
+image/vnd.fujixerox.edmics-mmr
+image/vnd.fujixerox.edmics-rlc
+image/vnd.mix
+image/vnd.net-fpx
+image/vnd.svf
+image/vnd.wap.wbmp				wbmp
+image/vnd.xiff
+image/x-cmu-raster				ras
+image/x-coreldraw				cdr
+image/x-coreldrawpattern			pat
+image/x-coreldrawtemplate			cdt
+image/x-corelphotopaint				cpt
+image/x-djvu					djvu djv
+image/x-icon					ico
+image/x-jg					art
+image/x-jng					jng
+image/x-photoshop				psd
+image/x-portable-anymap				pnm
+image/x-portable-bitmap				pbm
+image/x-portable-graymap			pgm
+image/x-portable-pixmap				ppm
+image/x-rgb					rgb
+image/x-xbitmap					xbm
+image/x-xpixmap					xpm
+image/x-xwindowdump				xwd
+
+inode/chardevice
+inode/blockdevice
+inode/directory-locked
+inode/directory
+inode/fifo
+inode/socket
+
+message/delivery-status
+message/disposition-notification
+message/external-body
+message/http
+message/s-http
+message/news
+message/partial
+message/rfc822
+
+model/iges					igs iges
+model/mesh					msh mesh silo
+model/vnd.dwf
+model/vnd.flatland.3dml
+model/vnd.gdl
+model/vnd.gs-gdl
+model/vnd.gtw
+model/vnd.mts
+model/vnd.vtu
+model/vrml					wrl vrml
+
+multipart/alternative
+multipart/appledouble
+multipart/byteranges
+multipart/digest
+multipart/encrypted
+multipart/form-data
+multipart/header-set
+multipart/mixed
+multipart/parallel
+multipart/related
+multipart/report
+multipart/signed
+multipart/voice-message
+
+text/calendar
+text/comma-separated-values			csv
+text/css					css
+text/directory
+text/english
+text/enriched
+text/h323					323
+text/html					htm html xhtml shtml
+text/iuls					uls
+text/mathml					mml
+text/parityfec
+text/plain					asc txt text diff pot
+text/prs.lines.tag
+text/x-psp					psp
+text/rfc822-headers
+text/richtext					rtx
+text/rtf					rtf
+text/scriptlet					sct wsc
+text/t140
+text/texmacs					tm ts
+text/tab-separated-values			tsv
+text/uri-list
+text/vnd.abc
+text/vnd.curl
+text/vnd.DMClientScript
+text/vnd.flatland.3dml
+text/vnd.fly
+text/vnd.fmi.flexstor
+text/vnd.in3d.3dml
+text/vnd.in3d.spot
+text/vnd.IPTC.NewsML
+text/vnd.IPTC.NITF
+text/vnd.latex-z
+text/vnd.motorola.reflex
+text/vnd.ms-mediapackage
+text/vnd.sun.j2me.app-descriptor		jad
+text/vnd.wap.si
+text/vnd.wap.sl
+text/vnd.wap.wml				wml
+text/vnd.wap.wmlscript				wmls
+text/xml					xml xsl
+text/x-c++hdr					h++ hpp hxx hh
+text/x-c++src					c++ cpp cxx cc
+text/x-chdr					h
+text/x-crontab
+text/x-csh					csh
+text/x-csrc					c
+text/x-java					java
+text/x-makefile
+text/xml-external-parsed-entity
+text/x-moc					moc
+text/x-pascal					p pas
+text/x-pcs-gcd					gcd
+text/x-python					py
+text/x-server-parsed-html
+text/x-setext					etx
+text/x-sh					sh
+text/x-tcl					tcl tk
+text/x-tex					tex ltx sty cls
+text/x-vcalendar				vcs
+text/x-vcard					vcf
+
+#video/avi					avi
+video/dl					dl
+video/fli					fli
+video/gl					gl
+video/mpeg					mpeg mpg mpe mp4
+video/quicktime					qt mov
+video/mp4v-es
+video/parityfec
+video/pointer
+video/vnd.fvt
+video/vnd.motorola.video
+video/vnd.motorola.videop
+video/vnd.mpegurl				mxu
+video/vnd.mts
+video/vnd.nokia.interleaved-multimedia
+video/vnd.vivo
+video/x-dv					dif dv
+video/x-la-asf					lsf lsx
+video/x-mng					mng
+video/x-ms-asf					asf asx
+video/x-ms-wm					wm
+video/x-ms-wmv					wmv
+video/x-ms-wmx					wmx
+video/x-ms-wvx					wvx
+video/x-msvideo					avi
+video/x-sgi-movie				movie
+
+x-conference/x-cooltalk				ice
+
+x-world/x-vrml					vrm vrml wrl

Modified: trunk/src/resources.inc
===================================================================
--- trunk/src/resources.inc	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/src/resources.inc	2005-12-01 18:53:54 UTC (rev 36)
@@ -27,6 +27,8 @@
 require_once('wikipedia.inc');
 require_once('meta.inc');
 require_once('tags.inc');
+require_once('cache.inc');
+require_once('mime-types.inc');
 
 define('XEEMES_RESOURCE_UNKNOWN',    1);
 define('XEEMES_RESOURCE_XML',        2);
@@ -139,14 +141,6 @@
     return XEEMES_RESOURCE_UNKNOWN;
   }
 
-  function url() {
-    return XEEMES_BASE_URL.'data'.$this-&gt;location; // TODO illegal chars, encoding
-  }
-
-  function view_url() {
-    return XEEMES_BASE_URL.'view.php'.$this-&gt;location;
-  }
-
   function extensions() {
     return array();
   }
@@ -176,21 +170,38 @@
     return file_exists($this-&gt;filename);
   }
 
+  function isUnmodified() {
+    return true;
+  }
+
   function stringContent() {
-    return file_get_contents($this-&gt;filename);
+    ob_start();
+    $this-&gt;outputContent();
+    $result = ob_get_contents();
+    ob_end_clean();
+    return $result;
   }
 
-  function isOriginal() {
-    return true;
+  function outputContent() {
+    readfile($this-&gt;filename);
   }
 
-  function outputContent() {
-    if ($this-&gt;isOriginal())
-      // TODO: this is supposed to be slow; and not very suitable for
-      // very large files, resp. low bandwidths
-      readfile($this-&gt;filename);
+  function getContentType() {
+    /* this all doesn't work that well
+    // try to get mime type from 'file -b -i' (Linux only!)
+    $res = @exec('file -b -i '.escapeshellarg($this-&gt;filename), $lines);
+    if (($res == 0) &amp;&amp; (count($lines) &gt; 0))
+      return $lines[0];
+    else if (file_exists($this-&gt;filename))
+      return mime_content_type($this-&gt;filename);
     else
-      print($this-&gt;stringContent());
+      return 'application/octet-stream';
+    */
+    $type = mime_content_type_ex($this-&gt;filename);
+    if ($type)
+      return $type;
+    else
+      return 'application/octet-stream';
   }
 
   function getLocation() {
@@ -215,6 +226,16 @@
   function getParentResource() {
     return get_resource(dirname($this-&gt;location), array());
   }
+
+  function getCacheInvalidator() {
+    return new XeemesCacheInvalidator();
+  }
+
+  // return something if this resource doesn't exist
+  function getNotFoundData() {
+    // TODO: override for image resources
+    return '&lt;html&gt;&lt;body&gt;&lt;h1&gt;Not Found&lt;/h1&gt;&lt;p&gt;The requested location '.$this-&gt;location.' was not found.&lt;/p&gt;&lt;hr&gt;xeemes&lt;/body&gt;&lt;/html&gt;';
+  }
 }
 
 // TODO: maybe move inline-code into classes
@@ -231,9 +252,35 @@
   }
 
   function extensions() {
-    return array('xml', 'xsl');
+    return array('xml', 'xsl', 'xhtml');
   }
 
+  function outputContent() {
+    $doc = $this-&gt;domContent();
+
+    //$this-&gt;process_instructions($doc); // TODO
+    XeemesTag::replaceTags($this, $doc-&gt;documentElement);
+
+    $layout_name = $this-&gt;get_meta('layout-name');
+    if (!$layout_name) $layout_name = 'default';
+    $layout_class = $this-&gt;get_meta('layout-class');
+    if ($layout_name) {
+      // class can be false
+      $layout = new Layout($layout_class, $layout_name);
+      $doc = $layout-&gt;process($doc, array('base-url' =&gt; XEEMES_BASE_URL));
+    }
+
+    // again after the layout transformation
+    //$this-&gt;process_instructions($doc); // TODO
+    XeemesTag::replaceTags($this, $doc-&gt;documentElement);
+    
+    print($doc-&gt;saveXML());
+  }
+
+  function isUnmodified() {
+    return false;
+  }
+
   function domContent() {
     $doc = DOMDocument::load($this-&gt;filename);
 
@@ -246,6 +293,16 @@
 
     return $doc;
   }
+
+  function getContentType() {
+    return 'text/html; charset=utf-8';
+  }
+
+  /* TODO: plus layout, everything that is included etc.
+  function getCacheInvalidator() {
+    return new XeemesCacheFileInvalidator($this-&gt;filename);
+  }
+  */
 }
 
 class HTMLResource extends XMLResource {
@@ -273,7 +330,7 @@
     $parser = new WikipediaParser();
     // TODO: look at charset meta-data
     return $parser-&gt;parse(iconv('iso-8859-1', 'utf-8',
-				$this-&gt;stringContent()));
+				file_get_contents($this-&gt;filename)));
   }
 }
 
@@ -288,7 +345,7 @@
   }
 }
 
-class ImageResource extends Resource {
+abstract class ImageResource extends Resource {
   /* display inline with &lt;img&gt; tag */
   /* conversions with GD library */
 
@@ -296,11 +353,13 @@
     return XEEMES_RESOURCE_IMAGE | parent::type();
   }
 
+  abstract function outputSameType($image);
+  abstract function imageContent();
+
   function outputContent() {
-    header('Content-Type: '.$this-&gt;contentType()); // this is abstract
     // TODO: size args
     if ($this-&gt;args['thumbnail'] == '1') {
-      $image = $this-&gt;imageContent(); // abstract
+      $image = $this-&gt;imageContent();
       $ow = imagesx($image); $oh = imagesy($image);
       $width = 100;
       $height = 100;
@@ -311,14 +370,26 @@
 	$width = $width * $ow / $oh;
       $thumb = imagecreatetruecolor($width, $height);
       imagefilledrectangle($thumb, 0, 0, $width, $height, 16777215);
-      imagecopyresampled($thumb, $image, 0, 0, 0, 0, $width, $height, $ow, $oh);
+      imagecopyresampled($thumb, $image, 0, 0, 0, 0, $width, $height,
+			 $ow, $oh);
 
-      $this-&gt;outputSameType($thumb); // abstract
+      $this-&gt;outputSameType($thumb);
       imagedestroy($thumb);
       imagedestroy($image);
     } else
       parent::outputContent();
   }
+
+  function isUnmodified() {
+    return (count($this-&gt;args) == 0); // more exact?
+  }
+
+  function getCacheInvalidator() {
+    if ($this-&gt;isUnmodified())
+      return new XeemesCacheInvalidator();
+    else
+      return new XeemesCacheFileInvalidator($this-&gt;filename);
+  }
 }
 
 class JPEGResource extends ImageResource {
@@ -334,7 +405,7 @@
     return imagecreatefromjpeg($this-&gt;filename);
   }
 
-  function contentType() {
+  function getContentType() {
     return &quot;image/jpeg&quot;;
   }
 
@@ -356,7 +427,7 @@
     return imagecreatefrompng($this-&gt;filename);
   }
 
-  function contentType() {
+  function getContentType() {
     return &quot;image/png&quot;;
   }
 
@@ -378,7 +449,7 @@
     return imagecreatefromgif($this-&gt;filename);
   }
 
-  function contentType() {
+  function getContentType() {
     return &quot;image/gif&quot;;
   }
 
@@ -431,6 +502,7 @@
       $filename = $path.$file;
       $pathinfo = pathinfo($filename);
       if (($file[0] != '.') &amp;&amp;
+	  ($file[0] != '_') &amp;&amp;
 	  ($pathinfo['extension'] != 'meta') &amp;&amp;
 	  (!in_array($pathinfo['basename'], $directory_indices)) &amp;&amp;
 	  ($file[strlen($file)-1] != '~')) {

Modified: trunk/src/tags.inc
===================================================================
--- trunk/src/tags.inc	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/src/tags.inc	2005-12-01 18:53:54 UTC (rev 36)
@@ -27,6 +27,15 @@
 
 require_once('resources.inc');
 
+function view_url($location) {
+  // TODO: this can be done better, abstract this, or make configurable
+  // this should work for both mod_rewrite on and off
+  if (isset($_SERVER['REDIRECT_URL']))
+    return XEEMES_BASE_URL.substr($location, 1); // strip '/'
+  else
+    return XEEMES_BASE_URL.'view.php'.$location;
+}
+
 function parse_url_arguments($spec) {
   $defs = explode('&amp;', $spec);
   $result = array();
@@ -153,7 +162,7 @@
       }
     } else if (($type &amp; XEEMES_RESOURCE_IMAGE) &gt; 0) {
       $img = $doc-&gt;createElement('img');
-      $url = XEEMES_BASE_URL.'view.php'.$iresource-&gt;getLocation();
+      $url = view_url($iresource-&gt;getLocation());
       // TODO: size, frame, etc.
       // TODO: prepend or append args to not override user-defined args?
       if ($attrs['special'] == 'thumbnail')
@@ -187,13 +196,14 @@
       $content []= $doc-&gt;createTextNode($iresource-&gt;getName());
     
     $link = $doc-&gt;createElement('a');
-    $href = XEEMES_BASE_URL.'view.php'.$ilocation;
+    $href = view_url($ilocation);
     if (count($args) &gt; 0)
       $href .= '?'.unparse_url_arguments($args);
     $link-&gt;setAttribute('href', $href);
-    $link-&gt;setAttribute('class', 'xeemes-internal');
     foreach ($content as $node)
       $link-&gt;appendChild($node);
+    if (!$link-&gt;hasAttribute('class'))
+      $link-&gt;setAttribute('class', 'xeemes-internal');
     return $link;
   }
 
@@ -254,33 +264,55 @@
     if (!isset($attrs['location']))
       return XeemesTag::error($doc, 'Gallery location not defined');
     $slocation = $attrs['location'];
+    $location = $resource-&gt;getLocation();
 
     $res = get_resource($slocation, array(), $resource-&gt;getLocation());
     if (!$res-&gt;exists())
       return XeemesTag::error('Gallery location not found: '.
 			      $res-&gt;getLocation());
-    $location = $res-&gt;getLocation();
   
-    $locations = self::find_locations($location, true);
+    $locations = self::find_locations($res-&gt;getLocation(), true);
 
+    $columns = max(isset($attrs['columns']) ? $attrs['columns'] : 6, 1);
+    $per_page = max(isset($attrs['images-per-page']) ?
+		    $attrs['images-per-page'] : 30, 1);
+
     if (isset($resource-&gt;args['image'])) { // TODO: maybe separate
 					   // resource and request args?
-      /* view single image */
+      $rt = new XeemesResourceTag();
+
+      $result = $doc-&gt;createElement('div');
+      $result-&gt;setAttribute('class', 'xeemes-gallery-image');
+
       $index = $resource-&gt;args['image'];
-      $rt = new XeemesResourceTag();
-      $res = $rt-&gt;toNode($resource, $doc,
-			 array('location' =&gt; $locations[$index],
-			       'display' =&gt; 'inline'));
-      // TODO: navigation
       $nexti = ($index + 1) % count($locations);
       $previ = (count($locations) + $index - 1) % count($locations);
 
-      return $res;
+      /* links backwards, up and forward */
+      $a = $rt-&gt;toNode($resource, $doc,
+		       array('location' =&gt; $location,
+			     'arguments' =&gt; 'image='.$previ));
+      $a-&gt;setAttribute('id', 'back');
+      $result-&gt;appendChild($a);
+      $a = $rt-&gt;toNode($resource, $doc,
+		       array('location' =&gt; $location,
+			     'arguments' =&gt; 'page='.floor($index / $per_page)));
+      $a-&gt;setAttribute('id', 'up');
+      $result-&gt;appendChild($a);
+      $a = $rt-&gt;toNode($resource, $doc,
+		       array('location' =&gt; $location,
+			     'arguments' =&gt; 'image='.$nexti));
+      $a-&gt;setAttribute('id', 'forward');
+      $result-&gt;appendChild($a);
+      
+      /* view single image */
+      $result-&gt;appendChild($rt-&gt;toNode($resource, $doc,
+				       array('location' =&gt; $locations[$index],
+					     'display' =&gt; 'inline')));
+
+      return $result;
     } else {
       /* overview page */
-      $columns = max(isset($attrs['columns']) ? $attrs['columns'] : 6, 1);
-      $per_page = max(isset($attrs['images-per-page']) ?
-	$attrs['images-per-page'] : 30, 1);
 
       if (isset($resource-&gt;args['page']))
 	$page = $resource-&gt;args['page'];
@@ -290,30 +322,36 @@
       $num_pages = count($locations)/$per_page;
 
       $results = array();
+
       /* links to the pages */
-      $rt = new XeemesResourceTag();
-      $links = $doc-&gt;createElement('div');
-      $links-&gt;setAttribute('class', 'xeemes-gallery-page-links');
-      for ($i = 0; $i &lt; $num_pages; $i++) {
-	$lnk = $rt-&gt;toNode($resource, $doc,
-			   array('location' =&gt; $resource-&gt;getLocation(),
-				 'arguments' =&gt; 'page='.$i),
-			   array($doc-&gt;createTextNode($i+1)));
-	$links-&gt;appendChild($lnk);
+      if ($num_pages &gt; 1) {
+	$rt = new XeemesResourceTag();
+	$links = $doc-&gt;createElement('div');
+	$links-&gt;setAttribute('class', 'xeemes-gallery-page-links');
+	for ($i = 0; $i &lt; $num_pages; $i++) {
+	  $lnk = $rt-&gt;toNode($resource, $doc,
+			     array('location' =&gt; $location,
+				   'arguments' =&gt; 'page='.$i),
+			     array($doc-&gt;createTextNode($i+1)));
+	  $links-&gt;appendChild($lnk);
+	}
+	$results []= $links;
       }
-      $results []= $links;
       
       /* thumbnails of images on this page */
       $thumbnails = array();
-      for ($i = $page * $per_page;
-	   $i &lt; min($per_page, count($locations) - ($page * $per_page));
+      $fromi = $page * $per_page;
+      $toi = min($fromi + $per_page,
+		 $fromi + count($locations) - ($page * $per_page));
+      for ($i = $fromi;
+	   $i &lt; $toi;
 	   $i++) {
 	$img = $rt-&gt;toNode($resource, $doc,
 			   array('location' =&gt; $locations[$i],
 				 'display' =&gt; 'inline',
 				 'special' =&gt; 'thumbnail'));
 	$lnk = $rt-&gt;toNode($resource, $doc,
-			   array('location' =&gt; $resource-&gt;getLocation(),
+			   array('location' =&gt; $location,
 				 'arguments' =&gt; 'image='.$i),
 			   array($img));
 	$thumbnails []= $lnk;
@@ -329,7 +367,7 @@
 	$td = $tr-&gt;appendChild($doc-&gt;createElement('td'));
 	$td-&gt;appendChild($thumb);
 
-	$row = ($row+1) % ($per_page / $columns);
+	$row = ($row+1) % $columns;
       }
       $results []= $table;
       

Modified: trunk/src/transformation.inc
===================================================================
--- trunk/src/transformation.inc	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/src/transformation.inc	2005-12-01 18:53:54 UTC (rev 36)
@@ -90,10 +90,14 @@
   return $doc;
 }
 
-function xeemes_parent_resource($include_subs = 0) {
+function xeemes_parent_resource($include_subs = 0, $more_up = 0) {
   global $xeemes_current_resource;
   $doc = new DOMDocument('1.0', 'utf-8');
   $parent = $xeemes_current_resource-&gt;getParentResource();
+  while ($more_up &gt; 0) {
+    $parent = $parent-&gt;getParentResource();
+    $more_up--;
+  }
   $doc-&gt;appendChild(resource_xml_representation($parent, $doc,
 						$include_subs));
   return $doc;

Modified: trunk/src/wikipedia.inc
===================================================================
--- trunk/src/wikipedia.inc	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/src/wikipedia.inc	2005-12-01 18:53:54 UTC (rev 36)
@@ -119,22 +119,68 @@
       $hr = $this-&gt;document-&gt;createElement('hr');
       $line-&gt;parentNode-&gt;replaceChild($hr, $line);
       return $hr-&gt;nextSibling;
-    } else if (!$line-&gt;hasChildNodes()) {
+    } else if ((!$line-&gt;hasChildNodes()) ||
+	       (($line-&gt;firstChild-&gt;nodeType == XML_TEXT_NODE) &amp;&amp;
+		($line-&gt;firstChild-&gt;textContent == ''))) {
       $pbr = $this-&gt;document-&gt;createElement('pbr');
       $line-&gt;parentNode-&gt;replaceChild($pbr, $line);
       return $pbr-&gt;nextSibling;
+    }
+    // multi-liners: lists, indentation, definition-lists, tables
+    else if (($line-&gt;firstChild-&gt;nodeType == XML_TEXT_NODE) &amp;&amp;
+	     (preg_match('/^([\*#:;])/', $line-&gt;firstChild-&gt;data, $matches))) {
+      return $this-&gt;process_next_multiliner($line, $matches[1]);
     } else {
       foreach (nodelist2array($line-&gt;childNodes) as $child) {
 	$line-&gt;removeChild($child);
 	$line-&gt;parentNode-&gt;insertBefore($child, $line);
       }
+      $line-&gt;parentNode-&gt;
+	insertBefore($line-&gt;ownerDocument-&gt;createTextNode(&quot;\n&quot;), $line);
       $next = $line-&gt;nextSibling;
       $line-&gt;parentNode-&gt;removeChild($line);
       return $next;
     }
-    // TODO: multi-liners: lists, indentation, definition-lists, tables
   }
 
+  function process_next_multiliner($start_line, $type) {
+    // first, get all following lines of this type
+    $lines = array($start_line);
+    $next = $start_line-&gt;nextSibling;
+    while ($next &amp;&amp; ($next-&gt;firstChild-&gt;nodeType == XML_TEXT_NODE) &amp;&amp;
+	   ($next-&gt;firstChild-&gt;data[0] == $type)) {
+      $lines []= $next;
+      $thisn = $next;
+      $next = $next-&gt;nextSibling;
+      $thisn-&gt;parentNode-&gt;removeChild($thisn);
+    }
+    $result = $next;
+
+    // now separate from content (TODO: in one step with 1?)
+    $things = array();
+    foreach ($lines as $line) {
+      $text = $line-&gt;firstChild;
+      preg_match('/^([\*#:;])(.*)$/', $text-&gt;data, $matches);
+      $text-&gt;data = $matches[2];
+      $things []= array($matches[1], $line);
+    }
+
+    // TODO: more complex and other lists
+    $doc = $start_line-&gt;ownerDocument;
+    $comp = $doc-&gt;createElement('ul');
+    foreach ($things as $tcontent) {
+      $content = $tcontent[1];
+      $li = $doc-&gt;createElement('li');
+      foreach (nodelist2array($content-&gt;childNodes) as $child) {
+	$li-&gt;appendChild($content-&gt;removeChild($child));
+      }
+      $comp-&gt;appendChild($li);
+    }
+    $start_line-&gt;parentNode-&gt;replaceChild($comp, $start_line);
+
+    return $result;
+  }
+
   function process_header($line, $depth) {
     $line-&gt;firstChild-&gt;splitText($depth);
     $line-&gt;removeChild($line-&gt;firstChild);
@@ -226,15 +272,17 @@
 	$last = $child;
       }
       $node-&gt;parentNode-&gt;removeChild($node);
-      return $last-&gt;nextSibling;
+      //return $last-&gt;nextSibling;
     } else if (($node-&gt;nodeType == XML_ELEMENT_NODE) &amp;&amp;
 	       ($node-&gt;nodeName != 'nowiki')) {
       $child = $node-&gt;firstChild;
       while ($child) {
-	$child = $this-&gt;process_inliners($child);
+	$next = $child-&gt;nextSibling;
+	$this-&gt;process_inliners($child);
+	$child = $next;
       }
     }
-    return $node-&gt;nextSibling;
+    //return $node-&gt;nextSibling;
   }
 
   /** */

Modified: trunk/view.php
===================================================================
--- trunk/view.php	2005-10-30 20:34:22 UTC (rev 35)
+++ trunk/view.php	2005-12-01 18:53:54 UTC (rev 36)
@@ -29,45 +29,39 @@
 require_once('src/resources.inc');
 require_once('src/authenticate.inc');
 require_once('src/transformation.inc');
+require_once('src/cache.inc');
 
 function view($location, $args) {
   $resource = get_resource($location, $args);
 
-  verify_view_authorization($resource);
-
   global $xeemes_current_resource;
   $xeemes_current_resource = $resource;
-  if (($resource-&gt;type() &amp; XEEMES_RESOURCE_XML) &gt; 0) {
-    if (!$resource-&gt;exists()) {
-      header('HTTP/1.1 404 Not found');
-      print('&lt;html&gt;&lt;body&gt;404 - not found&lt;/body&gt;&lt;/html&gt;'); // TODO
-    } else {
-      header('Content-Type: text/html; charset=utf-8');
-      $doc = $resource-&gt;domContent();
 
-      $layout_name = $resource-&gt;get_meta('layout-name');
-      if (!$layout_name) $layout_name = 'default';
-      $layout_class = $resource-&gt;get_meta('layout-class');
-      if ($layout_name) {
-	// class can be false
-	$layout = new Layout($layout_class, $layout_name);
-	$doc = $layout-&gt;process($doc, array()); // TODO parameters
-      }
-      //$this-&gt;process_instructions($doc); // TODO
-      XeemesTag::replaceTags($resource, $doc-&gt;documentElement);
+  if ($resource-&gt;exists()) {
+    $auth_info = verify_view_authorization($resource);
 
-      print($doc-&gt;saveXML());
+    $cache = new XeemesResourceCache('cache/');
+    header('Content-Type: '.$resource-&gt;getContentType());
+
+    // Problem: authenticate doesn't work then, because the browser
+    // thinks it's a different directory.
+    if ((!$auth_info) &amp;&amp; $resource-&gt;isUnmodified()) {
+      header('Location: '.XEEMES_BASE_URL.'data'.$location);
+    } else {
+      if (!$cache-&gt;output(array($location, $args))) {
+	$output = $resource-&gt;stringContent();
+	$inv = $resource-&gt;getCacheInvalidator();
+	$cache-&gt;insert(array($location, $args), $output, $inv);
+	print($output);
+      }
     }
   } else {
-    if (!$resource-&gt;exists())
-      header('HTTP/1.1 404 Not found');
-    else {
-      // header Content-type ??
-      $resource-&gt;outputContent();
-    }
+    header('HTTP/1.1 404 Not found');
+    print($resource-&gt;getNotFoundData());
   }
 }
 
-view($_SERVER['PATH_INFO'], $_GET);
+view(isset($_SERVER['PATH_INFO']) ? $_SERVER['PATH_INFO'] : $_SERVER['ORIG_PATH_INFO'],
+     $_GET);
 
 ?&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34">[ date ]</a>
              <a href="thread.html#34">[ thread ]</a>
              <a href="subject.html#34">[ subject ]</a>
              <a href="author.html#34">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/xeemes-commits">More information about the Xeemes-commits
mailing list</a><br>
</body></html>
